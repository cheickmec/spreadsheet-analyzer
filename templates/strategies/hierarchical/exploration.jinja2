{# Hierarchical exploration strategy template #}
{% extends "base/master.jinja2" %}

{% block system_context %}
You are performing a hierarchical exploration of the spreadsheet, starting with
high-level overview and progressively drilling down into areas of interest.
This approach helps manage complexity and focus analysis efforts effectively.
{% endblock %}

{% block task_description %}
{{ task.description }}

Exploration Level: {{ exploration_level | default('overview') }}
{% if parent_findings %}
Building on previous findings:
{{ parent_findings | truncate(500) }}
{% endif %}
{% endblock %}

{% block strategy_instructions %}
## Hierarchical Exploration Strategy

{% if exploration_level == 'overview' %}
### Level 1: Overview Analysis
1. Get sheet names and basic structure
2. Identify sheet purposes and relationships
3. Find key data areas and summary sheets
4. Detect overall patterns and organization
5. Recommend areas for deeper analysis

Focus on understanding the "big picture" before diving into details.

{% elif exploration_level == 'sheet' %}
### Level 2: Sheet-Level Analysis
1. Analyze structure of target sheet: {{ target_sheet }}
2. Identify data regions, headers, and formulas
3. Detect patterns in data organization
4. Find key calculations and aggregations
5. Map dependencies to other sheets

{% elif exploration_level == 'region' %}
### Level 3: Region-Level Analysis
1. Deep dive into specific region: {{ target_region }}
2. Analyze all formulas in detail
3. Validate calculations and logic
4. Check data quality and consistency
5. Document insights and anomalies

{% endif %}

### Progressive Refinement
- Build on previous level findings
- Maintain context from parent analyses
- Focus on most promising areas
- Skip low-value regions
{% endblock %}

{% block output_format %}
Structure your analysis code as follows:

```python
# Level {{ exploration_level }} Analysis: {{ task.description }}

# 1. Setup and context
# Load necessary data based on previous findings

# 2. Exploration
# Perform level-appropriate analysis

# 3. Key Findings
findings = {
    'level': '{{ exploration_level }}',
    'key_insights': [],
    'anomalies': [],
    'recommendations': [],
    'next_areas': []  # Areas recommended for deeper analysis
}

# 4. Validation
# Verify key findings

# 5. Summary
# Present structured results
```
{% endblock %}

{% block additional_sections %}
{% if exploration_level == 'overview' %}
<hints>
- Start with workbook.sheetnames to see all sheets
- Use pandas to quickly sample each sheet
- Look for sheets with names like 'Summary', 'Dashboard', 'Master'
- Identify sheets with the most formulas as likely calculation sheets
</hints>
{% endif %}
{% endblock %}
