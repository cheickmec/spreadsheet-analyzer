{# Macros for formatting context information #}

{% macro format_notebook_state(notebook) %}
## Current Notebook State

### Available Variables:
{% for var_name, var_info in notebook.variables.items() %}
- `{{ var_name }}`: {{ var_info.type }} - {{ var_info.description }}
{% endfor %}

### Executed Cells:
{% for cell in notebook.executed_cells[-5:] %}  {# Show last 5 cells #}
#### Cell {{ cell.index }} ({{ cell.execution_time }}):
```python
{{ cell.content | truncate(200) }}
```
{% if cell.output %}
Output: {{ cell.output | truncate(100) }}
{% endif %}
{% endfor %}
{% endmacro %}

{% macro format_excel_metadata(metadata) %}
## Excel File Information

- **File**: {{ metadata.filename }}
- **Size**: {{ metadata.size_mb }} MB
- **Sheets**: {{ metadata.sheet_count }} ({{ metadata.sheet_names | join(', ') | truncate(100) }})
- **Total Cells**: {{ metadata.total_cells }}
- **Formula Cells**: {{ metadata.formula_count }}
- **Last Modified**: {{ metadata.last_modified }}
{% endmacro %}

{% macro format_analysis_focus(focus) %}
## Analysis Focus

{% if focus.sheet_name %}
**Target Sheet**: {{ focus.sheet_name }}
{% endif %}

{% if focus.cell_range %}
**Cell Range**: {{ focus.cell_range }}
{% endif %}

{% if focus.analysis_type %}
**Analysis Type**: {{ focus.analysis_type }}
{% endif %}

{% if focus.specific_interest %}
**Specific Interest**: {{ focus.specific_interest }}
{% endif %}
{% endmacro %}

{% macro format_cell_samples(cells, max_samples=10) %}
## Cell Samples

{% for cell in cells[:max_samples] %}
- **{{ cell.coordinate }}**: {% if cell.formula %}={{ cell.formula }}{% else %}{{ cell.value }}{% endif %} ({{ cell.data_type }})
{% endfor %}
{% if cells|length > max_samples %}
... and {{ cells|length - max_samples }} more cells
{% endif %}
{% endmacro %}

{% macro format_dependency_graph(graph_info) %}
## Formula Dependencies

### Key Nodes (by importance):
{% for node in graph_info.top_nodes[:10] %}
- {{ node.cell }}: Score={{ node.score|round(3) }}, In-degree={{ node.in_degree }}, Out-degree={{ node.out_degree }}
{% endfor %}

### Detected Patterns:
{% for pattern in graph_info.patterns %}
- {{ pattern.type }}: {{ pattern.description }}
{% endfor %}
{% endmacro %}

{# Main context formatting - can be overridden by strategies #}
{% if notebook %}
{{ format_notebook_state(notebook) }}
{% endif %}

{% if excel_metadata %}
{{ format_excel_metadata(excel_metadata) }}
{% endif %}

{% if analysis_focus %}
{{ format_analysis_focus(analysis_focus) }}
{% endif %}

{% if cell_samples %}
{{ format_cell_samples(cell_samples) }}
{% endif %}

{% if dependency_graph %}
{{ format_dependency_graph(dependency_graph) }}
{% endif %}
