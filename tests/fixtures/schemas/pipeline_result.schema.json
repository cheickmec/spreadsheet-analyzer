{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Pipeline Result Schema",
  "description": "Language-agnostic schema for spreadsheet analyzer pipeline results",
  "type": "object",
  "required": ["success", "execution_time", "errors"],
  "properties": {
    "success": {
      "type": "boolean",
      "description": "Whether the pipeline completed successfully"
    },
    "execution_time": {
      "type": "number",
      "description": "Total execution time in seconds"
    },
    "errors": {
      "type": "array",
      "description": "List of error messages",
      "items": {
        "type": "string"
      }
    },
    "context": {
      "$ref": "#/definitions/pipeline_context"
    },
    "integrity": {
      "oneOf": [
        {"type": "null"},
        {"$ref": "#/definitions/integrity_result"}
      ]
    },
    "security": {
      "oneOf": [
        {"type": "null"},
        {"$ref": "#/definitions/security_report"}
      ]
    },
    "structure": {
      "oneOf": [
        {"type": "null"},
        {"$ref": "#/definitions/workbook_structure"}
      ]
    },
    "formulas": {
      "oneOf": [
        {"type": "null"},
        {"$ref": "#/definitions/formula_analysis"}
      ]
    },
    "content": {
      "oneOf": [
        {"type": "null"},
        {"$ref": "#/definitions/content_analysis"}
      ]
    }
  },
  "definitions": {
    "pipeline_context": {
      "type": "object",
      "properties": {
        "file_path": {
          "type": "string",
          "description": "Path to the analyzed file"
        },
        "start_time": {
          "type": "string",
          "format": "date-time"
        },
        "options": {
          "type": "object"
        }
      }
    },
    "integrity_result": {
      "type": "object",
      "required": ["file_hash", "is_excel", "trust_tier", "processing_class"],
      "properties": {
        "file_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$"
        },
        "file_path": {
          "type": "string"
        },
        "is_excel": {
          "type": "boolean"
        },
        "is_ooxml": {
          "type": "boolean"
        },
        "trust_tier": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10
        },
        "processing_class": {
          "type": "string",
          "enum": ["STANDARD", "HEAVY", "BLOCKED"]
        },
        "validation_passed": {
          "type": "boolean"
        },
        "scan_timestamp": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "security_report": {
      "type": "object",
      "required": ["risk_level", "risk_score", "has_macros", "threat_count"],
      "properties": {
        "risk_level": {
          "type": "string",
          "enum": ["LOW", "MEDIUM", "HIGH", "CRITICAL"]
        },
        "risk_score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "has_macros": {
          "type": "boolean"
        },
        "has_external_links": {
          "type": "boolean"
        },
        "has_embedded_objects": {
          "type": "boolean"
        },
        "threat_count": {
          "type": "integer",
          "minimum": 0
        },
        "threats": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/security_threat"
          }
        },
        "vba_modules": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "external_links": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "security_threat": {
      "type": "object",
      "required": ["threat_type", "severity", "description"],
      "properties": {
        "threat_type": {
          "type": "string"
        },
        "severity": {
          "type": "string",
          "enum": ["LOW", "MEDIUM", "HIGH", "CRITICAL"]
        },
        "description": {
          "type": "string"
        },
        "location": {
          "type": "string"
        },
        "remediation": {
          "type": "string"
        }
      }
    },
    "workbook_structure": {
      "type": "object",
      "required": ["sheet_count", "total_cells", "total_formulas", "complexity_score"],
      "properties": {
        "sheet_count": {
          "type": "integer",
          "minimum": 0
        },
        "total_cells": {
          "type": "integer",
          "minimum": 0
        },
        "total_formulas": {
          "type": "integer",
          "minimum": 0
        },
        "complexity_score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "has_vba_project": {
          "type": "boolean"
        },
        "has_external_links": {
          "type": "boolean"
        },
        "sheets": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/sheet_structure"
          }
        },
        "named_ranges": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "sheet_structure": {
      "type": "object",
      "required": ["name", "row_count", "column_count", "cell_count"],
      "properties": {
        "name": {
          "type": "string"
        },
        "row_count": {
          "type": "integer",
          "minimum": 0
        },
        "column_count": {
          "type": "integer",
          "minimum": 0
        },
        "cell_count": {
          "type": "integer",
          "minimum": 0
        },
        "formula_count": {
          "type": "integer",
          "minimum": 0
        },
        "has_data": {
          "type": "boolean"
        },
        "has_formulas": {
          "type": "boolean"
        },
        "has_charts": {
          "type": "boolean"
        },
        "has_pivot_tables": {
          "type": "boolean"
        },
        "used_range": {
          "type": "string",
          "pattern": "^[A-Z]+[0-9]+:[A-Z]+[0-9]+$"
        }
      }
    },
    "formula_analysis": {
      "type": "object",
      "required": ["has_circular_references", "max_dependency_depth", "formula_complexity_score"],
      "properties": {
        "has_circular_references": {
          "type": "boolean"
        },
        "max_dependency_depth": {
          "type": "integer",
          "minimum": 0
        },
        "formula_complexity_score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "circular_references": {
          "type": "array",
          "items": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "volatile_formulas": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "external_references": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "content_analysis": {
      "type": "object",
      "required": ["data_quality_score"],
      "properties": {
        "data_quality_score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "summary": {
          "type": "string"
        },
        "data_patterns": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/data_pattern"
          }
        },
        "insights": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/content_insight"
          }
        }
      }
    },
    "data_pattern": {
      "type": "object",
      "required": ["pattern_type", "confidence", "locations"],
      "properties": {
        "pattern_type": {
          "type": "string"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "description": {
          "type": "string"
        },
        "locations": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "content_insight": {
      "type": "object",
      "required": ["insight_type", "severity", "title"],
      "properties": {
        "insight_type": {
          "type": "string"
        },
        "severity": {
          "type": "string",
          "enum": ["INFO", "WARNING", "ERROR"]
        },
        "title": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "affected_sheets": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    }
  }
}
